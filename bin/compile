#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3

GEOIP_VERSION="1.6.6"
LIBMAXMIND_DIST_FILE="libmaxminddb-1.1.1.tar.gz"

VENDORED_GEOIP="vendor/geoip/$GEOIP_VERSION"
APP_GEOIP="/app/$VENDORED_GEOIP"

# Maxmind GeoIP database

GEOLITECITY_URL="http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"
GEOLITECITY_FILE="GeoLite2-City.mmdb"
LIBMAXMIND_DIST_URL="https://github.com/maxmind/libmaxminddb/releases/download/1.1.1/$LIBMAXMIND_DIST_FILE"
GEOIP_DIST_DIR="GeoIP-$GEOIP_VERSION"

mkdir -p $CACHE_DIR/.geoip
cd $CACHE_DIR/.geoip

LIBMAXMIND_DIST_HEADER=$APP_GEOIP/include/maxminddb.h

echo "-----> Installing LibMaxmind GeoIP $GEOIP_VERSION"
if [ ! -f $LIBMAXMIND_DIST_HEADER ]; then
  curl -s -L -o libmaxminddb-1.1.1.tar.gz $LIBMAXMIND_DIST_URL
  tar -zxvf libmaxminddb-1.1.1.tar.gz > /dev/null

  cd libmaxminddb-1.1.1
  ./configure --prefix="$APP_GEOIP" > /dev/null
  make > /dev/null
  make check > /dev/null
  make install
fi

cd $CACHE_DIR/.geoip

if [ ! -f $GEOLITECITY_FILE ]; then
    echo "     Downloading  $GEOLITECITY_FILE"

    curl -s -L -o ${GEOLITECITY_FILE}.gz $GEOLITECITY_URL
    gunzip ${GEOLITECITY_FILE}.gz > /dev/null
else
  echo "      $GEOLITECITY_FILE already cached"

fi
mkdir -p "$BUILD_DIR/$VENDORED_GEOIP/share/"
cp $GEOLITECITY_FILE "$BUILD_DIR/$VENDORED_GEOIP/share/$GEOLITECITY_FILE"
GEOIP_DB_PATH="$APP_GEOIP/share/$GEOLITECITY_FILE"

# populate profile.d
PROFILE_PATH="$BUILD_DIR/.profile.d/geo.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "       export GEOIP_DB_PATH=\"$GEOIP_DB_PATH\"" >> $PROFILE_PATH
echo "       export LD_LIBRARY_PATH=\"$APP_GEOIP/lib:\$LD_LIBRARY_PATH\""
echo "       export LD_LIBRARY_PATH=\"$APP_GEOIP/lib:\$LD_LIBRARY_PATH\"" >> $PROFILE_PATH
echo "       GeoIP City Database is available via env in \$GEOIP_DB_PATH = $GEOIP_DB_PATH"
cd $CACHE_DIR

mkdir -p $BUILD_DIR/.bundle
echo $LDFLAGS
echo $LDFLAGS
echo $CFLAGS

if [ ! -f $BUILD_DIR/.bundle/config ]
then
  echo "---" > $BUILD_DIR/.bundle/config
fi

cat .bundle/config
echo "BUNDLE_BUILD__MAXMIND_GEOIP2: \"--with-opt-include=$APP_GEOIP/include --with-opt-lib=$APP_GEOIP/lib\"" >> .bundle/config
cat .bundle/config

# bundle config build.maxmind_geoip2 --with-opt-include=/app/vendor/geoip/1.6.6/include/maxminddb_config.h
