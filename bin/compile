#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3

echo $BUILD_DIR
echo $CACHE_DIR
echo $ENV_FILE

GEOIP_VERSION="1.6.6"
LIBMAXMIND_DIST_FILE="libmaxminddb-1.1.1.tar.gz"

VENDORED_GEOIP="vendor/geoip/$GEOIP_VERSION"
APP_GEOIP="/app/$VENDORED_GEOIP"

# Maxmind GeoIP database

GEOLITECITY_URL="http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"
GEOLITECITY_FILE="GeoLite2-City.mmdb"
LIBMAXMIND_DIST_URL="https://github.com/maxmind/libmaxminddb/releases/download/1.1.1/$LIBMAXMIND_DIST_FILE"
GEOIP_DIST_DIR="GeoIP-$GEOIP_VERSION"

echo "Preparing directoryies: $CACHE_DIR/.geoip  $BUILD_DIR/$VENDORED_GEOIP"
mkdir -p $CACHE_DIR/.geoip
mkdir -p "$BUILD_DIR/$VENDORED_GEOIP"
mkdir -p "$BUILD_DIR/$VENDORED_GEOIP/share/"

cd $CACHE_DIR/.geoip

echo "-----> Installing LibMaxmind GeoIP $GEOIP_VERSION"

cd $CACHE_DIR/.geoip
# Download and build libmaxminddb
curl -s -L -o libmaxminddb-1.1.1.tar.gz $LIBMAXMIND_DIST_URL
tar -zxvf libmaxminddb-1.1.1.tar.gz > /dev/null
cd libmaxminddb-1.1.1
./configure --prefix="$CACHE_DIR/.geoip/libmaxminddb" > /dev/null
make > /dev/null
make check > /dev/null
make install

# Copy installed filed to build dir
cp -R $CACHE_DIR/.geoip/libmaxminddb $BUILD_DIR/$VENDORED_GEOIP

cd $CACHE_DIR/.geoip

if [ ! -f $GEOLITECITY_FILE ]; then
    echo "     Downloading  $GEOLITECITY_FILE"

    curl -s -L -o ${GEOLITECITY_FILE}.gz $GEOLITECITY_URL
    gunzip ${GEOLITECITY_FILE}.gz > /dev/null
else
  echo "      $GEOLITECITY_FILE already cached"
fi

cp $GEOLITECITY_FILE "$BUILD_DIR/$VENDORED_GEOIP/share/$GEOLITECITY_FILE"
GEOIP_DB_PATH="$APP_GEOIP/share/$GEOLITECITY_FILE"

LIBMAXMINDDB_PATH="$APP_GEOIP/libmaxminddb"
echo "Adding build options to BUNDLE_CONFIG"
mkdir -p $BUILD_DIR/.bundle
echo "OLD .bundle/config"

cat "$BUILD_DIR/.bundle/config"

BUNDLE_CONFIG=$BUILD_DIR/.bundle/config
CACHED_BUNDLE_CONFIG=$CACHE_DIR/.bundle/config

if [ -f $CACHED_BUNDLE_CONFIG ]; then
  echo " CACHED_BUNDLE_CONFIG exists"
  BUNDLED=$(grep -ic BUNDLE_BUILD__MAXMIND_GEOIP2 $CACHED_BUNDLE_CONFIG)
  if [ $BUNDLED -eq 1 ]
  then
    echo "Already bundled"
  else
    echo "Not bundled"
    BUNDLE_CONFIG_CONTENT="BUNDLE_BUILD__MAXMIND_GEOIP2: \"--with-opt-include=$LIBMAXMINDDB_PATH/include --with-opt-lib=$LIBMAXMINDDB_PATH/lib\"" >> $BUNDLE_CONFIG
    echo $BUNDLE_CONFIG_CONTENT > $CACHED_BUNDLE_CONFIG
  fi

else
  echo "no CACHED_BUNDLE_CONFIG"
fi

# if [ ! -f $BUNDLE_CONFIG ]; then
#   echo "Creating $BUNDLE_CONFIG"
#   echo "---" > $BUNDLE_CONFIG
# fi
# BUNDLE_CONFIG_CONTENT="BUNDLE_BUILD__MAXMIND_GEOIP2: \"--with-opt-include=$LIBMAXMINDDB_PATH/include --with-opt-lib=$LIBMAXMINDDB_PATH/lib\"" >> $BUNDLE_CONFIG
# echo $BUNDLE_CONFIG_CONTENT

PROFILE_PATH="$BUILD_DIR/.profile.d/geo.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "       export GEOIP_DB_PATH=\"$GEOIP_DB_PATH\"" >> $PROFILE_PATH
echo "       export MAXMIND_BINARY=\"$LIBMAXMINDDB_PATH/bin/mmdblookup\"" >> $PROFILE_PATH
echo "       export LD_LIBRARY_PATH=\"$LIBMAXMINDDB_PATH/lib:\$LD_LIBRARY_PATH\"" >> $PROFILE_PATH
# echo "       echo $BUNDLE_CONFIG_CONTENT >> /app/.bundle/config"

cat $PROFILE_PATH
echo "       GeoIP City Database is available via env in \$GEOIP_DB_PATH = $GEOIP_DB_PATH"
